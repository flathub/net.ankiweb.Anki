app-id: net.ankiweb.Anki
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.9'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    version: '24.08'
    directory: texlive
    add-ld-path: lib
    no-autodownload: true
command: anki
rename-desktop-file: anki.desktop
rename-icon: anki
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp
  # IBus support
  - --env=IBUS_USE_PORTAL=1
  # LaTeX
  - --env=PATH=/app/bin:/usr/bin:/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux
  # QtWebEngineProcess from baseapp
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  # Fix for fractional scaling fonts on wayland
  - --env=QT_SCALE_FACTOR_ROUNDING_POLICY=round
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /etc
  - /man
  - /lib/pkgconfig
  - /lib/metatypes
  - /share/bash-completion
  - /share/doc
  - /share/man
  - /share/zsh

modules:
  - name: texlive
    buildsystem: simple
    build-commands:
      - install -d /app/texlive

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dlibmpv=false
      - -Dmanpage-build=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.40.0.tar.gz
        sha256: 10a0f4654f62140a6dd4d380dcf0bbdbdcf6e697556863dc499c296182f081a3
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/refs/tags/v$version.tar.gz
    modules:
      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dvulkan=enabled
          - -Dd3d11=disabled
          - -Ddemos=False
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://github.com/haasn/libplacebo.git
            tag: v7.351.0
            commit: 3188549fba13bbdf3a5a98de2a38c2e71f04e21e
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.4/libass-0.17.4.tar.xz
            sha256: 78f1179b838d025e9c26e8fef33f8092f65611444ffa1bfc0cfac6a33511a05a
            x-checker-data:
              type: anitya
              project-id: 1560
              stable-only: true
              url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.xz

  - name: rsync
    cleanup:
      - /share
    sources:
      - type: archive
        url: https://download.samba.org/pub/rsync/src/rsync-3.4.1.tar.gz
        sha256: 2924bcb3a1ed8b551fc101f740b9f0fe0a202b115027647cf69850d65fd88c52
        x-checker-data:
          type: anitya
          project-id: 4217
          versions:
            <: '4.0'
          url-template: https://download.samba.org/pub/rsync/src/rsync-$version.tar.gz

  - python3-modules.json
  # pysocks certifi charset_normalizer decorator distro idna orjson protobuf requests typing_extensions urllib3 beautifulsoup4 flask flask-cors jsonschema pip-system-certs send2trash waitress
  # manual arch-dependent wheels: orjson, rpds_py

  - name: anki
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links=file://${PWD}
        --prefix=${FLATPAK_DEST} anki --no-build-isolation
    cleanup:
      - /share/pixmaps
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/29/75/81eb12d43381f5150a2fb1acc2757d25741af5bf0635f40faab61eefcb44/anki-25.7.5-cp39-abi3-manylinux_2_36_aarch64.whl
        sha256: 3481df9f8fc7b89d805f5d051dde3def97e49716f280630e7aeee548a0fe45e5
        only-arches:
          - aarch64
      - type: file
        url: https://files.pythonhosted.org/packages/a3/86/c1c459a06466ffc3a205de9852875a922c378a7bfb9fb1310bea019dacd1/anki-25.7.5-cp39-abi3-manylinux_2_36_x86_64.whl
        sha256: a3d2472e9aa6b1ecc7c05a56f3e9a5a3271155af7613e34ead0268180b18b981
        only-arches:
          - x86_64

  - name: aqt # bundling module, includes anki executable
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links=file://${PWD}
        --prefix=${FLATPAK_DEST} aqt --no-build-isolation
    post-install:
      - install -Dm644 -t /app/share/metainfo net.ankiweb.Anki.metainfo.xml
      - install -Dm644 -t /app/share/applications anki.desktop
      - install -Dm644 -t /app/share/icons/hicolor/scalable/apps anki.svg
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/5e/e6/4c36d3c1ed0e2a6e4bf95eb919d603078d935b5c75950c7627e79340f25a/aqt-25.7.5-py3-none-any.whl
        sha256: e3a6eebd8f6ffd320d2cf55d557dfeb2be4da69f9aaa2198b1783bb380d6c0ba
        x-checker-data:
          type: pypi
          name: aqt
          packagetype: bdist_wheel
      - type: file
        path: net.ankiweb.Anki.metainfo.xml
      - type: file
        path: anki.desktop
      - type: file
        path: anki.svg
