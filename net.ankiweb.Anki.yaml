app-id: net.ankiweb.Anki
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node24
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.9'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node24/bin
  env:
    npm_config_nodedir: /usr/lib/sdk/node24
add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    version: '24.08'
    directory: texlive
    add-ld-path: lib
    no-autodownload: true
command: anki
rename-desktop-file: anki.desktop
rename-icon: anki
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp
  # IBus support
  - --env=IBUS_USE_PORTAL=1
  # LaTeX
  - --env=PATH=/app/bin:/usr/bin:/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux
  # QtWebEngineProcess from baseapp
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  # Fix for fractional scaling fonts on wayland
  - --env=QT_SCALE_FACTOR_ROUNDING_POLICY=round
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /etc
  - /man
  - /lib/pkgconfig
  - /lib/metatypes
  - /share/bash-completion
  - /share/doc
  - /share/man
  - /share/zsh

modules:
  - name: texlive
    buildsystem: simple
    build-commands:
      - install -d /app/texlive

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dlibmpv=false
      - -Dmanpage-build=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.40.0.tar.gz
        sha256: 10a0f4654f62140a6dd4d380dcf0bbdbdcf6e697556863dc499c296182f081a3
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/refs/tags/v$version.tar.gz
    modules:
      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dvulkan=enabled
          - -Dd3d11=disabled
          - -Ddemos=False
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://github.com/haasn/libplacebo.git
            tag: v7.351.0
            commit: 3188549fba13bbdf3a5a98de2a38c2e71f04e21e
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.4/libass-0.17.4.tar.xz
            sha256: 78f1179b838d025e9c26e8fef33f8092f65611444ffa1bfc0cfac6a33511a05a
            x-checker-data:
              type: anitya
              project-id: 1560
              stable-only: true
              url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.xz

  - name: rsync
    cleanup:
      - /share
    sources:
      - type: archive
        url: https://download.samba.org/pub/rsync/src/rsync-3.4.1.tar.gz
        sha256: 2924bcb3a1ed8b551fc101f740b9f0fe0a202b115027647cf69850d65fd88c52
        x-checker-data:
          type: anitya
          project-id: 4217
          versions:
            <: '4.0'
          url-template: https://download.samba.org/pub/rsync/src/rsync-$version.tar.gz

  - name: python3-maturin
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-maturin/cargo
        CARGO_NET_OFFLINE: 'true'
    build-commands:
      - cargo --offline fetch --manifest-path ./Cargo.toml
      - cargo --offline build --release
      - install -Dm755 target/release/maturin -t ${FLATPAK_DEST}/bin
      - install -Dm644 maturin/__init__.py -t ${FLATPAK_DEST}/lib/python$(python -c
        'import sys; print("%s.%s" %sys.version_info[0:2])')/site-packages/maturin/
    sources:
      - cargo-sources-maturin.json
      - type: git
        url: https://github.com/PyO3/maturin
        tag: v1.9.4

  - name: uv-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "uv" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/13/fc/e0da45ee179367dcc1e1040ad00ed8a99b78355d43024b0b5fc2edf5c389/uv-0.8.15-py3-none-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 07765f99fd5fd3b257d7e210e8d0844c0a8fd111612e31fcca66a85656cc728e
        only-arches:
          - x86_64
      - type: file
        url: https://files.pythonhosted.org/packages/ce/5d/180904fa7ed49081b27f00e86f7220ca62cc098d7ef6459f0c69a8ae8f74/uv-0.8.15-py3-none-manylinux_2_28_aarch64.whl
        sha256: c4868e6a4e1a8c777a5ba3cff452c405837318fb0b272ff203bfda0e1b8fc54d
        only-arches:
          - aarch64
    cleanup:
      - '*'

  - name: python3-pycparser-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pycparser" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/a0/e3/59cd50310fc9b59512193629e1984c1f95e5c8ae6e5d8c69532ccc65a7fe/pycparser-2.23-py3-none-any.whl
        sha256: e5c6e8d3fbad53479cab09ac03729e0a9faf2bee3db8208a550daf5af81a5934
        x-checker-data:
          type: pypi
          name: pycparser
          packagetype: bdist_wheel

  - name: python3-cffi
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/eb/56/b1ba7935a17738ae8453301356628e8147c79dbb825bcbc73dc7401f9846/cffi-2.0.0.tar.gz
        sha256: 44d1b5909021139fe36001ae048dbdde8214afa20200eda0f64c068cac5d5529
        x-checker-data:
          type: pypi
          name: cffi

  - name: python3-asn1crypto-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "asn1crypto" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c9/7f/09065fd9e27da0eda08b4d6897f1c13535066174cc023af248fc2a8d5e5a/asn1crypto-1.5.1-py2.py3-none-any.whl
        sha256: db4e40728b728508912cbb3d44f19ce188f218e9eba635821bb4b68564f8fd67
        x-checker-data:
          type: pypi
          name: asn1crypto
          packagetype: bdist_wheel

  - name: python3-idna-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "idna" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/0e/61/66938bbb5fc52dbdf84594873d5b51fb1f7c7794e9c0f5bd885f30bc507b/idna-3.11-py3-none-any.whl
        sha256: 771a87f49d9defaf64091e6e6fe9c18d4833f140bd19464795bc32d966ca37ea
        x-checker-data:
          type: pypi
          name: idna
          packagetype: bdist_wheel

  - name: python3-cryptography-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/b8/56/d4f07ea21434bf891faa088a6ac15d6d98093a66e75e30ad08e88aa2b9ba/cryptography-45.0.7-cp37-abi3-manylinux_2_28_aarch64.whl
        sha256: dad43797959a74103cb59c5dac71409f9c27d34c8a05921341fb64ea8ccb1dd4
        only-arches:
          - aarch64
        x-checker-data:
          type: json
          url: https://pypi.org/pypi/cryptography/json
          version-query: .info.version
          url-query: .releases | .[$version][] | select(.filename=="cryptography-"
            + $version + "-cp37-abi3-manylinux_2_28_aarch64.whl") | .url
          name: cryptography
          packagetype: bdist_wheel
      - type: file
        url: https://files.pythonhosted.org/packages/83/dc/4dab2ff0a871cc2d81d3ae6d780991c0192b259c35e4d83fe1de18b20c70/cryptography-45.0.7-cp37-abi3-manylinux_2_28_x86_64.whl
        sha256: b04f85ac3a90c227b6e5890acb0edbaf3140938dbecf07bff618bf3638578cf1
        only-arches:
          - x86_64
        x-checker-data:
          type: json
          url: https://pypi.org/pypi/cryptography/json
          version-query: .info.version
          url-query: .releases | .[$version][] | select(.filename=="cryptography-"
            + $version + "-cp37-abi3-manylinux_2_28_x86_64.whl") | .url
          name: cryptography
          packagetype: bdist_wheel

  - name: python3-rpds_py-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "rpds_py" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/ed/7b/8f4fee9ba1fb5ec856eb22d725a4efa3deb47f769597c809e03578b0f9d9/rpds_py-0.27.1-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: 466bfe65bd932da36ff279ddd92de56b042f2266d752719beb97b08526268ec5
        only_arches:
          - x86_64
      - type: file
        url: https://files.pythonhosted.org/packages/6f/0e/e650e1b81922847a09cca820237b0edee69416a01268b7754d506ade11ad/rpds_py-0.27.1-cp312-cp312-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
        sha256: 16323f674c089b0360674a4abd28d5042947d54ba620f72514d69be4ff64845e
        only_arches:
          - aarch64

  - python3-modules.json # beautifulsoup4 flask flask_cors jsonschema requests send2trash waitress pip-system-certs hatch
  - python3-pylib-modules.json # protobuf decorator orjson markdown typing_extensions distro

  - name: anki
    buildsystem: simple
    build-options:
      env:
        OFFLINE_BUILD: '1'
        RELEASE: '2'
        PYTHON_BINARY: /usr/bin/python
        NODE_BINARY: /usr/lib/sdk/node24/bin/node
        # ANKI_YARN_BINARY: /usr/lib/sdk/node24/bin/yarn
        ANKI_YARN_BINARY: /run/build/anki/yarn.cjs
        YARN_GLOBAL_FOLDER: /run/build/anki/flatpak-node/yarn-mirror/global
        YARN_ENABLE_GLOBAL_CACHE: '0'
        YARN_ENABLE_NETWORK: '0'
        PROTOC_BINARY: /run/build/anki/protoc
        CARGO_HOME: /run/build/anki/cargo
        XDG_CACHE_HOME: /run/build/anki/flatpak-node/cache
        UV_BINARY: /app/bin/uv
        UV_PYTHON: /usr/bin/python
        UV_OFFLINE: '1'
    build-commands:
      - mkdir -p out/pyenv/bin
      - ln -s $PYTHON_BINARY out/pyenv/bin/python
      - cargo fetch --manifest-path ./Cargo.toml
      - mkdir out/node_modules
      - ln -sf out/node_modules ./
      - sed --in-place 's/configuration.get(`lockfileFilename`)/"yarn.lock"/g' $FLATPAK_BUILDER_BUILDDIR/flatpak-node/flatpak-yarn.js
      - "sed --in-place 's/\"type\": \"module\",/\"type\": \"module\"/' package.json"
      - sed --in-place '/packageManager/d' package.json
      - chmod +x yarn.cjs
      - ./yarn.cjs config
      - ./yarn.cjs plugin import $FLATPAK_BUILDER_BUILDDIR/flatpak-node/flatpak-yarn.js
      - ./yarn.cjs convertToZip ./yarn.cjs
      - ./yarn.cjs install
      - ./ninja wheels
      - for f in out/wheels/*.whl; do python -m installer --prefix="/app" $f; done
      - install -Dm644 ./qt/launcher/lin/anki.desktop /app/share/applications
      - install -Dm644 net.ankiweb.Anki.metainfo.xml /app/share/metainfo
      - install -Dm644 ./qt/launcher/lin/anki.xml /app/share/mime/packages/net.ankiweb.Anki.xml
      - install -Dm644 anki.svg /app/share/icons/hicolor/scalable/apps
    cleanup:
      - /share/pixmaps
    sources:
      - cargo-sources.json
      - yarn-sources.json
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v30.2/protoc-30.2-linux-aarch_64.zip
        sha256: a3173ea338ef91b1605b88c4f8120d6c8ccf36f744d9081991d595d0d4352996
        only-arches:
          - aarch64
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v30.2/protoc-30.2-linux-x86_64.zip
        sha256: 327e9397c6fb3ea2a542513a3221334c6f76f7aa524a7d2561142b67b312a01f
        only-arches:
          - x86_64
      - type: file
        url: https://raw.githubusercontent.com/yarnpkg/berry/refs/tags/%40yarnpkg/cli/4.9.2/packages/yarnpkg-cli/bin/yarn.js
        sha256: ca4310f8ba997b4643a000ce512d9772e01c1485df35511114b325315960acb7
        dest-filename: yarn.cjs
      - type: git
        url: https://github.com/ankitects/anki.git
        tag: 25.09.2
        commit: 3890e12c9e48c028c3f12aa58cb64bd9f8895e30
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ankitects/anki/releases/latest
          tag-query: .tag_name
      - type: patch
        paths:
          - no-update-check.patch
          - strip-python-formatter.patch
          - python-build-fixes.patch
          - desktop-file-name.patch
          - yarn-4-fixes.patch
          - strip-mpv-ytdl.patch
      # temp fix for hatchling resolution in offline uv
      - type: inline
        contents: |
          hatchling @ ./hatchling-1.27.0-py3-none-any.whl
          packaging @ ./packaging-25.0-py3-none-any.whl
          pathspec @ ./pathspec-0.12.1-py3-none-any.whl
          pluggy @ ./pluggy-1.6.0-py3-none-any.whl
          tomli @ ./tomli_w-1.2.0-py3-none-any.whl
          trove-classifiers @ ./trove_classifiers-2025.8.26.11-py3-none-any.whl
        dest-filename: uv-constraints.txt
      - type: file
        url: https://files.pythonhosted.org/packages/08/e7/ae38d7a6dfba0533684e0b2136817d667588ae3ec984c1a4e5df5eb88482/hatchling-1.27.0-py3-none-any.whl
        sha256: d3a2f3567c4f926ea39849cdf924c7e99e6686c9c8e288ae1037c8fa2a5d937b
      - type: file
        url: https://files.pythonhosted.org/packages/20/12/38679034af332785aac8774540895e234f4d07f7545804097de4b666afd8/packaging-25.0-py3-none-any.whl
        sha256: 29572ef2b1f17581046b3a2227d5c611fb25ec70ca1ba8554b24b0e69331a484
      - type: file
        url: https://files.pythonhosted.org/packages/cc/20/ff623b09d963f88bfde16306a54e12ee5ea43e9b597108672ff3a408aad6/pathspec-0.12.1-py3-none-any.whl
        sha256: a0d503e138a4c123b27490a4f7beda6a01c6f288df0e4a8b79c7eb0dc7b4cc08
      - type: file
        url: https://files.pythonhosted.org/packages/54/20/4d324d65cc6d9205fabedc306948156824eb9f0ee1633355a8f7ec5c66bf/pluggy-1.6.0-py3-none-any.whl
        sha256: e920276dd6813095e9377c0bc5566d94c932c33b27a3e3945d8389c374dd4746
      - type: file
        url: https://files.pythonhosted.org/packages/c7/18/c86eb8e0202e32dd3df50d43d7ff9854f8e0603945ff398974c1d91ac1ef/tomli_w-1.2.0-py3-none-any.whl
        sha256: 188306098d013b691fcadc011abd66727d3c414c571bb01b1a174ba8c983cf90
      - type: file
        url: https://files.pythonhosted.org/packages/4a/40/d54944eeb5646fb4b1c98d4601fe5e0812dd2e7c0aa94d53fc46457effc8/trove_classifiers-2025.8.26.11-py3-none-any.whl
        sha256: 887fb0a402bdbecd4415a52c06e6728f8bdaa506a7143372d2b893e2c5e2d859
      - type: file
        path: net.ankiweb.Anki.metainfo.xml
      - type: file
        path: anki.svg
