app-id: net.ankiweb.Anki
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    version: '22.08'
    directory: texlive # this is relative to /app
    no-autodownload: true
command: anki
rename-desktop-file: anki.desktop
rename-icon: anki
finish-args:
  # X11/Wayland
  - --socket=x11
  - --socket=wayland
  - --share=ipc
  - --device=dri
  # Flashcards with sound
  - --socket=pulseaudio
  # Sync
  - --share=network
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp
  # IBus support
  - --env=IBUS_USE_PORTAL=1
  # LaTeX
  - --env=PATH=/app/bin:/usr/bin:/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux

modules:
  - name: texlive
    buildsystem: simple
    build-commands:
      - install -d /app/texlive

  - name: libass
    sources:
      - type: archive
        url: https://github.com/libass/libass/releases/download/0.17.0/libass-0.17.0.tar.xz
        sha256: 971e2e1db59d440f88516dcd1187108419a370e64863f70687da599fdf66cc1a
        x-checker-data:
          type: anitya
          project-id: 1560
          stable-only: true
          url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.xz
      - type: script
        commands:
          - autoreconf -fiv
        dest-filename: autogen.sh
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share

  - name: mpv
    buildsystem: simple
    build-commands:
      - python3 waf configure --disable-alsa --disable-build-date --disable-manpage-build
        --prefix=/app
      - python3 waf build
      - python3 waf install
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.35.1.tar.gz
        sha256: 41df981b7b84e33a2ef4478aaf81d6f4f5c8b9cd2c0d337ac142fc20b387d1a9
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/refs/tags/v$version.tar.gz
      - type: file
        url: https://waf.io/waf-2.0.25
        sha256: 21199cd220ccf60434133e1fd2ab8c8e5217c3799199c82722543970dc8e38d5
        dest-filename: waf
        x-checker-data:
          type: anitya
          project-id: 5116
          stable-only: true
          url-template: https://waf.io/waf-$version
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share

  - name: krb5
    subdir: src
    config-opts:
      - --localstatedir=/var/lib
      - --sbindir=${FLATPAK_DEST}/bin
      - --disable-static
      - --disable-rpath
    build-commands:
      - install -Dm644 ../krb5.conf /app/etc/krb5.conf
    sources:
      - type: archive
        url: https://github.com/krb5/krb5/archive/refs/tags/krb5-1.20.1-final.tar.gz
        sha256: ec3861c3bec29aa8da9281953c680edfdab1754d1b1db8761c1d824e4b25496a
        x-checker-data:
          type: anitya
          project-id: 13287
          stable-only: true
          url-template: https://github.com/krb5/krb5/archive/refs/tags/krb5-$version.tar.gz
      - type: shell
        dest: src
        commands:
          - autoreconf -si
      - type: file
        path: krb5.conf
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share

  - name: anki
    buildsystem: simple
    build-commands:
      - ./install.sh
      - install -Dm644 -t /app/share/icons/hicolor/scalable/apps anki.svg
      - install -Dm644 -t /app/share/appdata net.ankiweb.Anki.appdata.xml
      - install -Dm644 anki.xml /app/share/mime/packages/net.ankiweb.Anki.xml
    cleanup:
      - /share/pixmaps
    sources:
      - type: archive
        url: https://github.com/ankitects/anki/releases/download/2.1.56/anki-2.1.56-linux-qt6.tar.zst
        sha256: 6e88acf3e5bf26fb5ed07a82e958bc59c5f3adcf32f1f2a85b7b6d6cf6ffbf5e
        x-checker-data:
          type: anitya
          is-main-source: true
          project-id: 49
          stable-only: true
          url-template: https://github.com/ankitects/anki/releases/download/$version/anki-$version-linux-qt6.tar.zst
      - type: file
        path: anki.svg
      - type: file
        path: net.ankiweb.Anki.appdata.xml
      - type: shell
        commands:
          - sed -i '/xdg-mime/d' install.sh
          - sed -i 's/PREFIX=\/usr\/local/PREFIX=\/app/' install.sh
