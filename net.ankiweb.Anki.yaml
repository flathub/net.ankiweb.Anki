app-id: net.ankiweb.Anki
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.9'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    version: '24.08'
    directory: texlive
    add-ld-path: lib
    no-autodownload: true
command: anki
rename-desktop-file: anki.desktop
rename-icon: anki
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp
  # IBus support
  - --env=IBUS_USE_PORTAL=1
  # LaTeX
  - --env=PATH=/app/bin:/usr/bin:/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux
  # QtWebEngineProcess from baseapp
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  # Fix for fractional scaling fonts on wayland
  - --env=QT_SCALE_FACTOR_ROUNDING_POLICY=round
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /etc
  - /man
  - /lib/pkgconfig
  - /lib/metatypes
  - /share/bash-completion
  - /share/doc
  - /share/man
  - /share/zsh

modules:
  - name: texlive
    buildsystem: simple
    build-commands:
      - install -d /app/texlive

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dlibmpv=false
      - -Dmanpage-build=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.40.0.tar.gz
        sha256: 10a0f4654f62140a6dd4d380dcf0bbdbdcf6e697556863dc499c296182f081a3
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/refs/tags/v$version.tar.gz
    modules:
      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dvulkan=enabled
          - -Dd3d11=disabled
          - -Ddemos=False
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://github.com/haasn/libplacebo.git
            tag: v7.349.0
            commit: 1fd3c7bde7b943fe8985c893310b5269a09b46c5
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.3/libass-0.17.3.tar.xz
            sha256: eae425da50f0015c21f7b3a9c7262a910f0218af469e22e2931462fed3c50959
            x-checker-data:
              type: anitya
              project-id: 1560
              stable-only: true
              url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.xz

  - name: rsync
    cleanup:
      - /share
    sources:
      - type: archive
        url: https://download.samba.org/pub/rsync/src/rsync-3.4.1.tar.gz
        sha256: 2924bcb3a1ed8b551fc101f740b9f0fe0a202b115027647cf69850d65fd88c52
        x-checker-data:
          type: anitya
          project-id: 4217
          versions:
            <: '4.0'
          url-template: https://download.samba.org/pub/rsync/src/rsync-$version.tar.gz

  - python3-modules.json
  # pysocks certifi charset_normalizer decorator distro idna orjson protobuf requests typing_extensions urllib3 beautifulsoup4 flask flask-cors jsonschema pip-system-certs send2trash waitress
  # manual arch-dependent wheels: orjson, rpds_py

  - name: anki
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} anki --no-build-isolation
    cleanup:
      - /share/pixmaps
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/ed/0a/6f07edb9b60c0aa5e5ea2546ffb2f9cf079dd6b7b5b90f0d31852978c3b9/anki-25.7.2-cp39-abi3-manylinux_2_36_aarch64.whl
        sha256: b631d1f9cebbb7f3aae90d954bbef3e1d162a9f2475b58eebdfe359f93c442fb
        only-arches:
          - aarch64
      - type: file
        url: https://files.pythonhosted.org/packages/bf/05/3f3e0e890408cd8bf590bb00029de1623d85a09f2bc40545f87f4fa5e0f8/anki-25.7.2-cp39-abi3-manylinux_2_36_x86_64.whl
        sha256: 72e4ffc762b0d44940f1749e9f435347d7f39591e8e443ed547480baf8f16cf0
        only-arches:
          - x86_64

  - name: aqt # bundling module, includes anki executable
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} aqt --no-build-isolation
    post-install:
      - install -Dm644 -t /app/share/metainfo net.ankiweb.Anki.metainfo.xml
      - install -Dm644 -t /app/share/applications anki.desktop
      - install -Dm644 -t /app/share/icons/hicolor/scalable/apps anki.svg
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/83/0b/51bf1a1f623fe52a590050087dcdfdaeab72025a2dd02bb6e5d3627de4e2/aqt-25.7.2-py3-none-any.whl
        sha256: 51045a8f80482dd60a6749818d4ed11e83f421519430582cd28e3d9278832442
      - type: file
        path: net.ankiweb.Anki.metainfo.xml
      - type: file
        path: anki.desktop
      - type: file
        path: anki.svg
