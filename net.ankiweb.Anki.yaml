app-id: net.ankiweb.Anki
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.9'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    version: '24.08'
    directory: texlive
    add-ld-path: lib
    no-autodownload: true
command: anki
rename-desktop-file: anki.desktop
rename-icon: anki
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp
  # IBus support
  - --env=IBUS_USE_PORTAL=1
  # LaTeX
  - --env=PATH=/app/bin:/usr/bin:/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux
  # QtWebEngineProcess from baseapp
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  # Fix for fractional scaling fonts on wayland
  - --env=QT_SCALE_FACTOR_ROUNDING_POLICY=round
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /etc
  - /man
  - /lib/pkgconfig
  - /lib/metatypes
  - /share/bash-completion
  - /share/doc
  - /share/man
  - /share/zsh

modules:
  - name: texlive
    buildsystem: simple
    build-commands:
      - install -d /app/texlive

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dlibmpv=false
      - -Dmanpage-build=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.40.0.tar.gz
        sha256: 10a0f4654f62140a6dd4d380dcf0bbdbdcf6e697556863dc499c296182f081a3
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/refs/tags/v$version.tar.gz
    modules:
      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dvulkan=enabled
          - -Dd3d11=disabled
          - -Ddemos=False
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://github.com/haasn/libplacebo.git
            tag: v7.351.0
            commit: 3188549fba13bbdf3a5a98de2a38c2e71f04e21e
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.4/libass-0.17.4.tar.xz
            sha256: 78f1179b838d025e9c26e8fef33f8092f65611444ffa1bfc0cfac6a33511a05a
            x-checker-data:
              type: anitya
              project-id: 1560
              stable-only: true
              url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.xz

  - name: rsync
    cleanup:
      - /share
    sources:
      - type: archive
        url: https://download.samba.org/pub/rsync/src/rsync-3.4.1.tar.gz
        sha256: 2924bcb3a1ed8b551fc101f740b9f0fe0a202b115027647cf69850d65fd88c52
        x-checker-data:
          type: anitya
          project-id: 4217
          versions:
            <: '4.0'
          url-template: https://download.samba.org/pub/rsync/src/rsync-$version.tar.gz

  - python3-modules.json
  # pysocks certifi charset_normalizer decorator distro idna orjson protobuf requests typing_extensions urllib3 beautifulsoup4 flask flask-cors jsonschema pip-system-certs send2trash waitress
  # manual arch-dependent wheels: orjson, rpds_py

  - name: anki
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links=file://${PWD}
        --prefix=${FLATPAK_DEST} anki --no-build-isolation
    cleanup:
      - /share/pixmaps
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/8b/a6/54e42b834d96dade5372c8c96f5eff98d81f362c34bd38cc826c67524eec/anki-25.7.3-cp39-abi3-manylinux_2_36_aarch64.whl
        sha256: 024db54f2e7d4c5d0524c17c1e0f392edfdab61deb773bf376f0935889319bda
        only-arches:
          - aarch64
      - type: file
        url: https://files.pythonhosted.org/packages/0c/f7/465de8d65f7c5c37a7c5d28529a430d21cbd6a1587059be3c71c1a305502/anki-25.7.3-cp39-abi3-manylinux_2_36_x86_64.whl
        sha256: 8d7a2ff454f0f82260f3ab32a97e11d94e746d25026647fb38829fba2215c9bd
        only-arches:
          - x86_64

  - name: aqt # bundling module, includes anki executable
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links=file://${PWD}
        --prefix=${FLATPAK_DEST} aqt --no-build-isolation
    post-install:
      - install -Dm644 -t /app/share/metainfo net.ankiweb.Anki.metainfo.xml
      - install -Dm644 -t /app/share/applications anki.desktop
      - install -Dm644 -t /app/share/icons/hicolor/scalable/apps anki.svg
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/1c/72/f3ab92491fd080d0f60b462fd8e3e09ccc394ca1142939c7f4a65d35637d/aqt-25.7.3-py3-none-any.whl
        sha256: bfe2cb4f2b41f322cc5d579db0099d4785bf5f3c003dbe8d88f8f8f486d7042b
      - type: file
        path: net.ankiweb.Anki.metainfo.xml
      - type: file
        path: anki.desktop
      - type: file
        path: anki.svg
