app-id: net.ankiweb.Anki
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
command: anki
rename-desktop-file: anki.desktop
rename-icon: anki
finish-args:
  # X11/Wayland
  - --socket=x11
  - --share=ipc
  - --device=dri
  # Flashcards with sound
  - --socket=pulseaudio
  # Sync
  - --share=network
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp

modules:
  - name: mpv
    buildsystem: simple
    build-commands:
      - python3 waf configure
          --disable-alsa
          --disable-build-date
          --disable-libass
          --disable-manpage-build
          --disable-oss-audio
          --prefix=/app
      - python3 waf build
      - python3 waf install
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/v0.32.0.tar.gz
        sha256: 9163f64832226d22e24bbc4874ebd6ac02372cd717bef15c28a0aa858c5fe592 
      - type: file
        url: https://waf.io/waf-2.0.15
        sha256: 34b8156ea375089e1bed5a31acfaff4024f6f3e96f3bee98f801f0c281ad3d2c
        dest-filename: waf
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share

  - name: anki
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    post-install:
      - install -Dm644 -t /app/share/icons/hicolor/scalable/apps anki.svg
      - install -Dm644 -t /app/share/appdata net.ankiweb.Anki.appdata.xml
      - install -Dm644 anki.xml /app/share/mime/packages/net.ankiweb.Anki.xml
      # .mo files are in a non-standard directory, work-around that,
      # so that Flatpak and Appstream can find the files
      - mv /app/share/anki/bin/aqt_data/locale /app/share/locale
      - ln -s /app/share/locale /app/share/anki/bin/aqt_data/locale
    cleanup:
      - /share/pixmaps
    sources:
      - type: archive
        url: https://github.com/ankitects/anki/releases/download/2.1.35/anki-2.1.35-linux-amd64.tar.bz2
        sha256: c0429a5e3a91ae1edf57f4af779072f4337056e363f854dc3db300d3c4eb6b02
      - type: file
        path: anki.svg
      - type: file
        path: net.ankiweb.Anki.appdata.xml
      - type: shell
        commands:
        - sed -i '/xdg-mime/d' Makefile
