app-id: net.ankiweb.Anki
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
  - org.freedesktop.Sdk.Extension.node24
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.9'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
build-options:
  append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node24/bin
  env:
    npm_config_nodedir: /usr/lib/sdk/node24
add-extensions:
  org.freedesktop.Sdk.Extension.texlive:
    version: '24.08'
    directory: texlive
    add-ld-path: lib
    no-autodownload: true
command: anki
rename-desktop-file: anki.desktop
rename-icon: anki
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
  # Allow other instances to see lockfiles
  - --env=TMPDIR=/var/tmp
  # IBus support
  - --env=IBUS_USE_PORTAL=1
  # LaTeX
  - --env=PATH=/app/bin:/usr/bin:/app/texlive/bin/x86_64-linux:/app/texlive/bin/aarch64-linux
  # QtWebEngineProcess from baseapp
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  # Fix for fractional scaling fonts on wayland
  - --env=QT_SCALE_FACTOR_ROUNDING_POLICY=round
cleanup:
  - '*.a'
  - '*.la'
  - /include
  - /etc
  - /man
  - /lib/pkgconfig
  - /lib/metatypes
  - /share/bash-completion
  - /share/doc
  - /share/man
  - /share/zsh

modules:
  - name: texlive
    buildsystem: simple
    build-commands:
      - install -d /app/texlive

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dlibmpv=false
      - -Dmanpage-build=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.40.0.tar.gz
        sha256: 10a0f4654f62140a6dd4d380dcf0bbdbdcf6e697556863dc499c296182f081a3
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/refs/tags/v$version.tar.gz
    modules:
      - name: libplacebo
        buildsystem: meson
        config-opts:
          - -Dvulkan=enabled
          - -Dd3d11=disabled
          - -Ddemos=False
        cleanup:
          - /include
          - /lib/pkgconfig
        sources:
          - type: git
            url: https://github.com/haasn/libplacebo.git
            tag: v7.351.0
            commit: 3188549fba13bbdf3a5a98de2a38c2e71f04e21e
            x-checker-data:
              type: git
              tag-pattern: ^v([\d.]+)$
      - name: libass
        config-opts:
          - --disable-static
        sources:
          - type: archive
            url: https://github.com/libass/libass/releases/download/0.17.4/libass-0.17.4.tar.xz
            sha256: 78f1179b838d025e9c26e8fef33f8092f65611444ffa1bfc0cfac6a33511a05a
            x-checker-data:
              type: anitya
              project-id: 1560
              stable-only: true
              url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.xz

  - name: rsync
    cleanup:
      - /share
    sources:
      - type: archive
        url: https://download.samba.org/pub/rsync/src/rsync-3.4.1.tar.gz
        sha256: 2924bcb3a1ed8b551fc101f740b9f0fe0a202b115027647cf69850d65fd88c52
        x-checker-data:
          type: anitya
          project-id: 4217
          versions:
            <: '4.0'
          url-template: https://download.samba.org/pub/rsync/src/rsync-$version.tar.gz

  - name: python3-maturin
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-maturin/cargo
        CARGO_NET_OFFLINE: 'true'
    build-commands:
      - cargo --offline fetch --manifest-path ./Cargo.toml
      - cargo --offline build --release
      - install -Dm755 target/release/maturin -t ${FLATPAK_DEST}/bin
      - install -Dm644 maturin/__init__.py -t ${FLATPAK_DEST}/lib/python$(python -c
        'import sys; print("%s.%s" %sys.version_info[0:2])')/site-packages/maturin/
    sources:
      - cargo-sources-maturin.json
      - type: git
        url: https://github.com/PyO3/maturin
        tag: v1.9.2

  - name: uv-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "uv" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/42/e2/5cf11c85fb48276b49979ea06e92c1e95524e1e4c5bccbd591a334c8de68/uv-0.8.4-py3-none-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
        sha256: f9cd287982f62419f98ca7182fbbc2fd0fad1a04008b956a88eb85ce1d522611
        only-arches:
          - x86_64
      - type: file
        url: https://files.pythonhosted.org/packages/1c/b1/773dcd5ef4947a5bd7c183f1cc8afb9e761488ff1b48b46cb0d95bc5c8cf/uv-0.8.4-py3-none-manylinux_2_28_aarch64.whl
        sha256: e6fa3754a2b965dceecfce8c38cacf7cd6b76a2787b9e189cf33acdb64a7472a
        only-arches:
          - aarch64

  - name: python3-pycparser-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pycparser" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/13/a3/a812df4e2dd5696d1f351d58b8fe16a405b234ad2886a0dab9183fb78109/pycparser-2.22-py3-none-any.whl
        sha256: c3702b6d3dd8c7abc1afa565d7e63d53a1d0bd86cdc24edd75470f4de499cfcc
        x-checker-data:
          type: pypi
          name: pycparser
          packagetype: bdist_wheel

  - name: python3-cffi
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/fc/97/c783634659c2920c3fc70419e3af40972dbaf758daa229a7d6ea6135c90d/cffi-1.17.1.tar.gz
        sha256: 1c39c6016c32bc48dd54561950ebd6836e1670f2ae46128f67cf49e789c52824
        x-checker-data:
          type: pypi
          name: cffi

  - name: python3-asn1crypto-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "asn1crypto" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c9/7f/09065fd9e27da0eda08b4d6897f1c13535066174cc023af248fc2a8d5e5a/asn1crypto-1.5.1-py2.py3-none-any.whl
        sha256: db4e40728b728508912cbb3d44f19ce188f218e9eba635821bb4b68564f8fd67
        x-checker-data:
          type: pypi
          name: asn1crypto
          packagetype: bdist_wheel

  - name: python3-idna-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "idna" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/76/c6/c88e154df9c4e1a2a66ccf0005a88dfb2650c1dffb6f5ce603dfbd452ce3/idna-3.10-py3-none-any.whl
        sha256: 946d195a0d259cbba61165e88e65941f16e9b36ea6ddb97f00452bae8b1287d3
        x-checker-data:
          type: pypi
          name: idna
          packagetype: bdist_wheel

  - name: python3-cryptography-bin
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/f7/6e/286894f6f71926bc0da67408c853dd9ba953f662dcb70993a59fd499f111/cryptography-45.0.6-cp37-abi3-manylinux_2_28_aarch64.whl
        sha256: 20ae4906a13716139d6d762ceb3e0e7e110f7955f3bc3876e3a07f5daadec5f3
        only-arches:
          - aarch64
        x-checker-data:
          type: json
          url: https://pypi.org/pypi/cryptography/json
          version-query: .info.version
          url-query: .releases | .[$version][] | select(.filename=="cryptography-"
            + $version + "-cp37-abi3-manylinux_2_28_aarch64.whl") | .url
          name: cryptography
          packagetype: bdist_wheel
      - type: file
        url: https://files.pythonhosted.org/packages/f9/b9/c6d32edbcba0cd9f5df90f29ed46a65c4631c4fbe11187feb9169c6ff506/cryptography-45.0.6-cp37-abi3-manylinux_2_28_x86_64.whl
        sha256: 18f878a34b90d688982e43f4b700408b478102dd58b3e39de21b5ebf6509c301
        only-arches:
          - x86_64
        x-checker-data:
          type: json
          url: https://pypi.org/pypi/cryptography/json
          version-query: .info.version
          url-query: .releases | .[$version][] | select(.filename=="cryptography-"
            + $version + "-cp37-abi3-manylinux_2_28_x86_64.whl") | .url
          name: cryptography
          packagetype: bdist_wheel

  - python3-modules.json # beautifulsoup4 flask flask_cors jsonschema requests send2trash waitress pip-system-certs hatch
  - python3-runtime-modules.json # protobuf decorator orjson markdown typing_extensions distro

  - name: anki
    buildsystem: simple
    build-options:
      env:
        OFFLINE_BUILD: '1'
        RELEASE: '2'
        PYTHON_BINARY: /usr/bin/python
        NODE_BINARY: /usr/lib/sdk/node24/bin/node
        # ANKI_YARN_BINARY: /usr/lib/sdk/node24/bin/yarn
        ANKI_YARN_BINARY: /run/build/anki/yarn.cjs
        YARN_GLOBAL_FOLDER: /run/build/anki/flatpak-node/yarn-mirror/global
        YARN_ENABLE_GLOBAL_CACHE: '0'
        YARN_ENABLE_NETWORK: '0'
        PROTOC_BINARY: /run/build/anki/protoc
        CARGO_HOME: /run/build/anki/cargo
        XDG_CACHE_HOME: /run/build/anki/flatpak-node/cache
        UV_BINARY: /app/bin/uv
        UV_PYTHON: /usr/bin/python
        UV_OFFLINE: '1'
    build-commands:
      - mkdir -p out/pyenv/bin
      - ln -s $PYTHON_BINARY out/pyenv/bin/python
      - cargo fetch --manifest-path ./Cargo.toml
      - mkdir out/node_modules
      - ln -sf out/node_modules ./
      - sed --in-place 's/configuration.get(`lockfileFilename`)/"yarn.lock"/g' $FLATPAK_BUILDER_BUILDDIR/flatpak-node/flatpak-yarn.js
      - "sed --in-place 's/\"type\": \"module\",/\"type\": \"module\"/' package.json"
      - sed --in-place '/packageManager/d' package.json
      - chmod +x yarn.cjs
      - pwd
      - ./yarn.cjs config
      - ./yarn.cjs plugin import $FLATPAK_BUILDER_BUILDDIR/flatpak-node/flatpak-yarn.js
      - ./yarn.cjs convertToZip ./yarn.cjs
      - ./yarn.cjs install
      - ./ninja wheels
      - for f in out/wheels/*.whl; do python -m installer --prefix="/app" $f; done
      - install -Dm644 ./qt/launcher/lin/anki.desktop /app/share/applications
      - install -Dm644 net.ankiweb.Anki.metainfo.xml /app/share/metainfo
      - install -Dm644 ./qt/launcher/lin/anki.xml /app/share/mime/packages/net.ankiweb.Anki.xml
      - install -Dm644 -t /app/share/icons/hicolor/scalable/apps anki.svg
    cleanup:
      - /share/pixmaps
    sources:
      - cargo-sources.json
      - yarn-sources.json
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v30.2/protoc-30.2-linux-aarch_64.zip
        sha256: a3173ea338ef91b1605b88c4f8120d6c8ccf36f744d9081991d595d0d4352996
        only-arches:
          - aarch64
      - type: archive
        url: https://github.com/protocolbuffers/protobuf/releases/download/v30.2/protoc-30.2-linux-x86_64.zip
        sha256: 327e9397c6fb3ea2a542513a3221334c6f76f7aa524a7d2561142b67b312a01f
        only-arches:
          - x86_64
      - type: file
        url: https://raw.githubusercontent.com/yarnpkg/berry/refs/tags/%40yarnpkg/cli/4.9.2/packages/yarnpkg-cli/bin/yarn.js
        sha256: ca4310f8ba997b4643a000ce512d9772e01c1485df35511114b325315960acb7
        dest-filename: yarn.cjs
      - type: git
        url: https://github.com/ankitects/anki.git
        tag: 25.07.5
        commit: 7172b2d26684c7ef9d10e249bd43dc5bf73ae00c
        x-checker-data:
          type: json
          url: https://api.github.com/repos/ankitects/anki/releases/latest
          tag-query: .tag_name
      - type: patch
        paths:
          - no-update-check.patch
          - strip-python-formatter.patch
          - python-build-fixes.patch
          - desktop-file-name.patch
          - yarn-4-fixes.patch
          - strip-mpv-ytdl.patch
      # temp fix for hatching resolution in offline uv
      - type: inline
        contents: |
          hatchling @ ./hatchling-1.27.0-py3-none-any.whl
          packaging @ ./packaging-25.0-py3-none-any.whl
          pathspec @ ./pathspec-0.12.1-py3-none-any.whl
          pluggy @ ./pluggy-1.6.0-py3-none-any.whl
          tomli @ ./tomli_w-1.2.0-py3-none-any.whl
          trove-classifiers @ ./trove_classifiers-2025.5.9.12-py3-none-any.whl
        dest-filename: uv-constraints.txt
      - type: file
        url: https://files.pythonhosted.org/packages/08/e7/ae38d7a6dfba0533684e0b2136817d667588ae3ec984c1a4e5df5eb88482/hatchling-1.27.0-py3-none-any.whl
        sha256: d3a2f3567c4f926ea39849cdf924c7e99e6686c9c8e288ae1037c8fa2a5d937b
      - type: file
        url: https://files.pythonhosted.org/packages/20/12/38679034af332785aac8774540895e234f4d07f7545804097de4b666afd8/packaging-25.0-py3-none-any.whl
        sha256: 29572ef2b1f17581046b3a2227d5c611fb25ec70ca1ba8554b24b0e69331a484
      - type: file
        url: https://files.pythonhosted.org/packages/cc/20/ff623b09d963f88bfde16306a54e12ee5ea43e9b597108672ff3a408aad6/pathspec-0.12.1-py3-none-any.whl
        sha256: a0d503e138a4c123b27490a4f7beda6a01c6f288df0e4a8b79c7eb0dc7b4cc08
      - type: file
        url: https://files.pythonhosted.org/packages/54/20/4d324d65cc6d9205fabedc306948156824eb9f0ee1633355a8f7ec5c66bf/pluggy-1.6.0-py3-none-any.whl
        sha256: e920276dd6813095e9377c0bc5566d94c932c33b27a3e3945d8389c374dd4746
      - type: file
        url: https://files.pythonhosted.org/packages/c7/18/c86eb8e0202e32dd3df50d43d7ff9854f8e0603945ff398974c1d91ac1ef/tomli_w-1.2.0-py3-none-any.whl
        sha256: 188306098d013b691fcadc011abd66727d3c414c571bb01b1a174ba8c983cf90
      - type: file
        url: https://files.pythonhosted.org/packages/92/ef/c6deb083748be3bcad6f471b6ae983950c161890bf5ae1b2af80cc56c530/trove_classifiers-2025.5.9.12-py3-none-any.whl
        sha256: e381c05537adac78881c8fa345fd0e9970159f4e4a04fcc42cfd3129cca640ce
      - type: file
        path: net.ankiweb.Anki.metainfo.xml
      - type: file
        path: anki.svg
